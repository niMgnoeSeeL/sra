#### Running the sampling instrumentation + Fuzztastic + AFLCC

#### Make sure we have the library `libsample_runtime.a` and `SampleArgsPass.so` under `workspaces/fuzzer/utils`
```bash
WORK=/workspaces/fuzzer
# When loading and running the SampleArgsPass, this flag will instruct it to only instrument the specified functions: f
export SAMPLE_ONLY_FNS="f"  # Replace with the actual function name you want to sample
export LDFLAGS="-lfuzztasticrt -L$WORK/utils -lsample_runtime $LDFLAGS"
```

#### Example (demo.c)
```bash
cd /workspaces/fuzzer
# (Optional) Run the formatter, if it has not been done
./utils/myfmt -i subjects/demo/demo.c
WORK=/workspaces/fuzzer
LDFLAGS="-lfuzztasticrt -L$WORK/utils -lsample_runtime $LDFLAGS"
cd subjects/demo

# Compile to whole-binary with gclang
# For reference: https://github.com/tum-i4/fuzztastic/blob/9df8e11c585e7a8e7310ea36341fca62f06ea555/scripts/demo/demo.sh#L84-L88
gclang -g -O0 -Xclang -disable-O0-optnone -fno-inline demo.c -o demo
# Decompile to bitcode --> demo.bc
get-bc demo

# (Optional) If you want to observe the bitcode
# llvm-dis/llvm-dis-20 demo.bc -o demo.ll

# Instrument with sampling pass
SAMPLE_ONLY_FNS=f opt -load-pass-plugin=$WORK/utils/SampleArgsPass.so -passes="function(sample-args)" demo.bc -o demo_sample.bc

# We need to navigate to FT_DIR to run this
DEMO_DIR=/workspaces/fuzzer/subjects/demo
cd $FT_DIR
poetry run fuzztastic/ instrument --input-bc "$DEMO_DIR/demo_sample.bc" --output-bc "$DEMO_DIR/demo_sample.ft.bc" --output "$DEMO_DIR/demo.ft.json"

# cd back to demo directory
cd $DEMO_DIR

# (Optional) At the point, if you want to run the SAMPLE+FT instrumented binary
# clang demo_sample.ft.bc -o demo_sample.ft $LDFLAGS

# Compile with afl-cc
$WORK/AFLplusplus/afl-clang-fast -O0 -fno-inline demo_sample.ft.bc $LDFLAGS -o demo_sample.ft.afl

# Prepare fuzzing campaign directory
mkdir -p fuzz_campaign
fuzzing_cmd="timeout 300 $WORK/AFLplusplus/afl-fuzz -i $DEMO_DIR/seed_corpus/ -o $DEMO_DIR/fuzz_campaign -- $DEMO_DIR/demo_sample.ft.afl @@"

export AFL_TRY_AFFINITY=1
export AFL_NO_SYNC=1

# Launch Fuzztastic
echo "ðŸš€ Launching FuzzTastic with command: $fuzzing_cmd"

cd $FT_DIR
poetry run fuzztastic/ monitor --input "$DEMO_DIR/demo.ft.json" --command "$fuzzing_cmd" --visualization --output "$DEMO_DIR/coverages"

# The frequency of saving coverage reports && visualization updates can be adjusted in fuzztastic/config.yaml
# I set it to 10 secs
```